<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Canary Deployment dan Mirroring Dengan Traefik - Anwar's Blog</title><meta name=Description content="Canary Release dengan Traefik berbasis pembobotan round robin hingga mirroring traffic"><meta property="og:title" content="Canary Deployment dan Mirroring Dengan Traefik"><meta property="og:description" content="Canary Release dengan Traefik berbasis pembobotan round robin hingga mirroring traffic"><meta property="og:type" content="article"><meta property="og:url" content="https://init.web.id/canary-deployment-dan-mirroring-dengan-traefik/"><meta property="og:image" content="https://init.web.id/canary-deployment-dan-mirroring-dengan-traefik/cover.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-26T00:55:48+07:00"><meta property="article:modified_time" content="2022-06-26T05:37:48+07:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://init.web.id/canary-deployment-dan-mirroring-dengan-traefik/cover.jpg"><meta name=twitter:title content="Canary Deployment dan Mirroring Dengan Traefik"><meta name=twitter:description content="Canary Release dengan Traefik berbasis pembobotan round robin hingga mirroring traffic"><meta name=application-name content="Anwar's Blog"><meta name=apple-mobile-web-app-title content="Anwar's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://init.web.id/canary-deployment-dan-mirroring-dengan-traefik/><link rel=prev href=https://init.web.id/setup-gitlab-server-with-ansible/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Canary Deployment dan Mirroring Dengan Traefik","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/init.web.id\/canary-deployment-dan-mirroring-dengan-traefik\/"},"image":[{"@type":"ImageObject","url":"https:\/\/init.web.id\/canary-deployment-dan-mirroring-dengan-traefik\/cover.jpg","width":700,"height":290}],"genre":"posts","keywords":"Traefik, Ingress, Deployment, Kubernetes","wordcount":1233,"url":"https:\/\/init.web.id\/canary-deployment-dan-mirroring-dengan-traefik\/","datePublished":"2022-06-26T00:55:48+07:00","dateModified":"2022-06-26T05:37:48+07:00","license":"\u003ca href=\"https://creativecommons.org/licenses/by-nc/4.0/\" target=\"_blank\" rel=\"noopener\"\u003eCC BY-NC 4.0\u003c/a\u003e","publisher":{"@type":"Organization","name":"anwareset","logo":"https:\/\/github.com\/anwareset.png"},"author":{"@type":"Person","name":"anwareset"},"description":"Canary Release dengan Traefik berbasis pembobotan round robin hingga mirroring traffic"}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"light"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"light"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Anwar's Blog"><span class=header-title-pre><i class='fas fa-hashtag'></i>&nbsp</span><span id=id-1 class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Anwar's Blog"><span class=header-title-pre><i class='fas fa-hashtag'></i>&nbsp</span><span id=id-2 class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Canary Deployment dan Mirroring Dengan Traefik</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://init.web.id/about title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>anwareset</a></span>&nbsp;<span class=post-category>included in <a href=/categories/platform/><i class="far fa-folder fa-fw"></i>Platform</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-06-26>2022-06-26</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1233 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;6 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/canary-deployment-dan-mirroring-dengan-traefik/cover.jpg data-srcset="/canary-deployment-dan-mirroring-dengan-traefik/cover.jpg, /canary-deployment-dan-mirroring-dengan-traefik/cover.jpg 1.5x, /canary-deployment-dan-mirroring-dengan-traefik/cover.jpg 2x" data-sizes=auto alt=/canary-deployment-dan-mirroring-dengan-traefik/cover.jpg title="Canary Release dengan Traefik berbasis pembobotan round robin hingga mirroring traffic"></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#canary-idiom>Canary Idiom</a><ul><li><a href=#kubernetess-canary>Kubernetes&rsquo;s Canary</a></li></ul></li><li><a href=#traefik>Traefik</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#scenario>Scenario</a><ul><li><a href=#tanpa-canary>Tanpa Canary</a></li><li><a href=#weighted-canary>Weighted Canary</a></li><li><a href=#canary-by-header>Canary by Header</a></li><li><a href=#mirroring>Mirroring</a></li></ul></li><li><a href=#advantages>Advantages</a></li><li><a href=#references>References</a></li></ul></nav></div></div><div class=content id=content><p>Saat kita melakukan deployment aplikasi ke versi terbaru pada Kubernetes, mungkin muncul kecemasan akan adanya insiden tak terduga walaupun versi terbaru sudah lolos tahap testing. Guna mengurangi kemungkinan insiden dalam skala besar, kita dapat memakai skenario bernama Canary.</p><h2 id=canary-idiom>Canary Idiom</h2><p>Frasa Canary dalam deployment aplikasi berasal dari sejarah penambang batu bara di awal abad 20. Pekerja tambang membawa burung kenari dalam sangkar ke terowongan bawah tanah, sehingga ketika muncul gas berbahaya seperti <a href=https://id.wikipedia.org/wiki/Karbon_monoksida#Toksisitas target=_blank rel="noopener noreffer">karbon monoksida</a> maka burung kenari akan mati dan menjadi peringatan bagi para pekerja untuk segera evakuasi.</p><h3 id=kubernetess-canary>Kubernetes&rsquo;s Canary</h3><p>Fitur canary pada Kubernetes biasanya tersedia jika kita menggunakan solusi <em>service mesh</em>. Namun sebenarnya canary dapat diimplementasikan tanpanya. Sebagai contohnya adalah menggunakan <a href=https://kubernetes.github.io/ingress-nginx/ target=_blank rel="noopener noreffer">Ingress Nginx</a>, <a href=https://haproxy-ingress.github.io/ target=_blank rel="noopener noreffer">HAProxy Ingress</a>, hingga <a href=https://traefik.io target=_blank rel="noopener noreffer">Traefik</a>. Jika tertarik, silahkan cari <a href=https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/ target=_blank rel="noopener noreffer">Kubernetes Ingress Controller</a> lainnya yang mendukung fitur canary pada tabel <a href="https://docs.google.com/spreadsheets/d/191WWNpjJ2za6-nbG4ZoUMXMpUK8KlCIosvQB0f-oq3k/edit?fbclid=IwAR2vaSsGgTKZWw4RaA-meycB8tnfcWf1vp1pC29TEsUm-EYad1r5oAI-HDM#gid=907731238" target=_blank rel="noopener noreffer">berikut</a>.</p><h2 id=traefik>Traefik</h2><p>Traefik adalah <del>Cloud Native Edge Router</del> salah satu <em>reverse proxy</em> dan <em>load balancer</em>. Terlepas dari gimmick <strong>cloud-native</strong>, yang menjadikan Traefik berbeda dari Nginx, HAproxy, dan yang lain adalah tersedianya <em>configurability</em> secara otomatis dan dinamis. Bagian paling menonjol darinya mungkin adalah kemampuan <em>automatic service discovery</em>. Jika kita menggunakan Traffic di atas Docker, Kubernetes, atau bahkan cara lama seperti sekedar VM dan <em>bare-metal</em> untuk menjajakan service yang berjalan di dalamnya. Layaknya sulap, Traefik akan me-<em>expose</em> service tersebut ke dunia luar. Tentu jika kita mengikuti dokumentasi dengan benar.</p><p><figure><a class=lightgallery href=/canary-deployment-dan-mirroring-dengan-traefik/traefik-v2-high-level-arch.png title="Traefik High Level Architecture" data-thumbnail=/canary-deployment-dan-mirroring-dengan-traefik/traefik-v2-high-level-arch.png data-sub-html="<h2>Traefik V2</h2><p>Traefik High Level Architecture</p>"><img class=lazyload src=/svg/loading.min.svg data-src=traefik-v2-high-level-arch.png data-srcset="/canary-deployment-dan-mirroring-dengan-traefik/traefik-v2-high-level-arch.png, traefik-v2-high-level-arch.png 1.5x, /canary-deployment-dan-mirroring-dengan-traefik/traefik-v2-high-level-arch.png 2x" data-sizes=auto alt=/canary-deployment-dan-mirroring-dengan-traefik/traefik-v2-high-level-arch.png></a><figcaption class=image-caption>Traefik V2</figcaption></figure></p><hr><h2 id=prerequisites>Prerequisites</h2><p>Untuk mempersingkat artikel ini, maka saya anggap beberapa hal ini sudah terpenuhi.</p><ol><li>Kubernetes cluster telah tersedia.</li><li>Traefik sudah terpasang pada Kubernetes.</li><li>Pemahaman mengenai Ingress, Service, dan Deployment pada Kubernetes.</li></ol><hr><h2 id=scenario>Scenario</h2><h3 id=tanpa-canary>Tanpa Canary</h3><p><figure><a class=lightgallery href=/canary-deployment-dan-mirroring-dengan-traefik/existing-release.png title="Traffic flow on existing release" data-thumbnail=/canary-deployment-dan-mirroring-dengan-traefik/existing-release.png data-sub-html="<h2>Existing release</h2><p>Traffic flow on existing release</p>"><img class=lazyload src=/svg/loading.min.svg data-src=existing-release.png data-srcset="/canary-deployment-dan-mirroring-dengan-traefik/existing-release.png, existing-release.png 1.5x, /canary-deployment-dan-mirroring-dengan-traefik/existing-release.png 2x" data-sizes=auto alt=/canary-deployment-dan-mirroring-dengan-traefik/existing-release.png></a><figcaption class=image-caption>Existing release</figcaption></figure>Pada contoh di atas, terlihat saya mempunyai sebuah service dengan aplikasi versi pertama yang anggaplah sudah mengudara dan menerima request dari user. Kurang lebih seperti inilah bagaimana service tersebut dapat berjalan.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl create deployment deployment-app-current --image<span class=o>=</span>trianwar/hello-app:1.0 -n default
</span></span><span class=line><span class=cl>kubectl expose deployment deployment-app-current --name service-app-current --type ClusterIP --port <span class=m>8080</span> -n default
</span></span></code></pre></td></tr></table></div></div><p>Selanjutnya kita buat sebuah <code>IngressRoute</code> dengan Traefik.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>traefik.containo.us/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>IngressRoute</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ingressroute-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>entryPoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>routes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Rule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>match</span><span class=p>:</span><span class=w> </span><span class=l>Host(`app.minikube1.local`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>service-app-current</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Simpan misalnya dengan nama ingressroute-app.yaml dan terapkan konfigurasi di atas</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl create -f ingressroute-app.yam -n default
</span></span></code></pre></td></tr></table></div></div><p>Jika dilakukan request dengan <code>curl</code> maka akan menjawab seperti berikut.<figure><a class=lightgallery href=/canary-deployment-dan-mirroring-dengan-traefik/without-canary.png title="Pengujian Tanpa Canary" data-thumbnail=/canary-deployment-dan-mirroring-dengan-traefik/without-canary.png data-sub-html="<h2>Trafik diarahkan ke versi aplikasi pertama</h2><p>Pengujian Tanpa Canary</p>"><img class=lazyload src=/svg/loading.min.svg data-src=without-canary.png data-srcset="/canary-deployment-dan-mirroring-dengan-traefik/without-canary.png, without-canary.png 1.5x, /canary-deployment-dan-mirroring-dengan-traefik/without-canary.png 2x" data-sizes=auto alt=/canary-deployment-dan-mirroring-dengan-traefik/without-canary.png></a><figcaption class=image-caption>Trafik diarahkan ke versi aplikasi pertama</figcaption></figure>Dari sini mari kita berasumsi bahwa aplikasi kita telah menerima aliran trafik sepenuhnya. Lalu suatu ketika saya melakukan ingin merilis versi aplikasi kedua.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl <span class=nb>set</span> image deployment/deployment-app-current hello-app<span class=o>=</span>trianwar/hello-app:2.0
</span></span><span class=line><span class=cl>kubectl rollout restart deployment/deployment-app-current
</span></span></code></pre></td></tr></table></div></div><p>Kita dapat melakukan rolling release ke versi terbaru tanpa canary, yang hasilnya tentu saja trafik akan sepenuhnya dialirkan ke satu-satunya rilis yang tersedia yaitu misalkan versi <code>2.0.0</code> seperti berikut.<figure><a class=lightgallery href=/canary-deployment-dan-mirroring-dengan-traefik/without-canary-result.png title="Deployment Tanpa Canary" data-thumbnail=/canary-deployment-dan-mirroring-dengan-traefik/without-canary-result.png data-sub-html="<h2>Trafik diarahkan ke versi aplikasi kedua</h2><p>Deployment Tanpa Canary</p>"><img class=lazyload src=/svg/loading.min.svg data-src=without-canary-result.png data-srcset="/canary-deployment-dan-mirroring-dengan-traefik/without-canary-result.png, without-canary-result.png 1.5x, /canary-deployment-dan-mirroring-dengan-traefik/without-canary-result.png 2x" data-sizes=auto alt=/canary-deployment-dan-mirroring-dengan-traefik/without-canary-result.png></a><figcaption class=image-caption>Trafik diarahkan ke versi aplikasi kedua</figcaption></figure></p><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fw"></i>Perhatian<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>Dari sini, lebih baiknya kita kembalikan <code>image tag</code> dari <code>deployment-app-current</code> ke versi <code>1.0.0</code> agar praktik selanjutnya sesuai dengan skenario.</div></div></div><h3 id=weighted-canary>Weighted Canary</h3><p>Alih - alih langsung mengganti rilis pertama ke versi terbaru sekaligus, di sini kita akan mendeploy aplikasi versi kedua sebagai rilisan baru. Dan selanjutnya kita manipulasi besaran traffic yang dialirkan.<figure><a class=lightgallery href=/canary-deployment-dan-mirroring-dengan-traefik/weighted-canary.png title="Trafik akan dibagi ke dua rilis yang berbeda sesuai dengan pembobotan yang ditentukan" data-thumbnail=/canary-deployment-dan-mirroring-dengan-traefik/weighted-canary.png data-sub-html="<h2>Weighted Canary</h2><p>Trafik akan dibagi ke dua rilis yang berbeda sesuai dengan pembobotan yang ditentukan</p>"><img class=lazyload src=/svg/loading.min.svg data-src=weighted-canary.png data-srcset="/canary-deployment-dan-mirroring-dengan-traefik/weighted-canary.png, weighted-canary.png 1.5x, /canary-deployment-dan-mirroring-dengan-traefik/weighted-canary.png 2x" data-sizes=auto alt=/canary-deployment-dan-mirroring-dengan-traefik/weighted-canary.png></a><figcaption class=image-caption>Weighted Canary</figcaption></figure>Untuk menggunakan fitur canary kita perlu memisahkan rilis terbaru ke deployment dan service baru. Besar aliran trafik akan kita tentukan dengan pembobotan. Pada diagram di atas, terlihat bahwa 80% traffic akan diarahkan ke versi pertama, sisanya sebesar 20% diarahkan ke versi kedua.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl create deployment deployment-app-canary --image<span class=o>=</span>trianwar/hello-app:2.0 -n default
</span></span><span class=line><span class=cl>kubectl expose deployment deployment-app-canary --name service-app-canary --type ClusterIP --port <span class=m>8080</span> -n default
</span></span></code></pre></td></tr></table></div></div><p>Kemudian modifikasi file manifest <code>ingressroute-app.yaml</code> tadi menjadi seperti berikut.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>traefik.containo.us/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>IngressRoute</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ingressroute-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>entryPoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>routes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Rule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>match</span><span class=p>:</span><span class=w> </span><span class=l>Host(`app.minikube1.local`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>service-app-current</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>service-app-canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Jangan lupa kita terapkan perubahannya.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl appy -f ingressroute-app.yaml
</span></span></code></pre></td></tr></table></div></div><p>Mari kita jalankan 100 request dengan menggunakan <code>curl</code> seperti berikut.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=k>for</span> i in <span class=o>{</span>1..100<span class=o>}</span><span class=p>;</span> <span class=k>do</span> curl -s app.minikube1.local <span class=p>|</span> grep Version<span class=p>;</span> <span class=k>done</span> <span class=p>|</span> sort <span class=p>|</span> uniq -c
</span></span></code></pre></td></tr></table></div></div><p>Akan terhitung bahwa trafik sebanyak 80% dialirkan ke aplikasi versi pertama, dan sisanya 20% ke versi kedua.</p><p><figure><a class=lightgallery href=/canary-deployment-dan-mirroring-dengan-traefik/weighted-canary-result.png title="Dari hasil pengujian terlihat bahwa trafik terbagi berdasarkan pembobotan yang ditentukan" data-thumbnail=/canary-deployment-dan-mirroring-dengan-traefik/weighted-canary-result.png data-sub-html="<h2>Weighted Canary Result</h2><p>Dari hasil pengujian terlihat bahwa trafik terbagi berdasarkan pembobotan yang ditentukan</p>"><img class=lazyload src=/svg/loading.min.svg data-src=weighted-canary-result.png data-srcset="/canary-deployment-dan-mirroring-dengan-traefik/weighted-canary-result.png, weighted-canary-result.png 1.5x, /canary-deployment-dan-mirroring-dengan-traefik/weighted-canary-result.png 2x" data-sizes=auto alt=/canary-deployment-dan-mirroring-dengan-traefik/weighted-canary-result.png></a><figcaption class=image-caption>Weighted Canary Result</figcaption></figure></p><h3 id=canary-by-header>Canary by Header</h3><p>Semisal yang kita inginkan adalah melakukan canary namun bukan untuk end-user langsung, melainkan untuk kebutuhan testing. Traefik juga mendukung manipulasi trafik berdasarkan <em>Request Header</em> dengan menggunakan objek <strong>Middleware</strong>.</p><p><figure><a class=lightgallery href=/canary-deployment-dan-mirroring-dengan-traefik/canary-by-header.png title="Request hanya akan dialirkan jika mengandung Header yang ditentukan" data-thumbnail=/canary-deployment-dan-mirroring-dengan-traefik/canary-by-header.png data-sub-html="<h2>Canary by Header</h2><p>Request hanya akan dialirkan jika mengandung Header yang ditentukan</p>"><img class=lazyload src=/svg/loading.min.svg data-src=canary-by-header.png data-srcset="/canary-deployment-dan-mirroring-dengan-traefik/canary-by-header.png, canary-by-header.png 1.5x, /canary-deployment-dan-mirroring-dengan-traefik/canary-by-header.png 2x" data-sizes=auto alt=/canary-deployment-dan-mirroring-dengan-traefik/canary-by-header.png></a><figcaption class=image-caption>Canary by Header</figcaption></figure></p><p>Contoh file manifest untuk membuat middleware adalah sebagai berikut, simpan dengan nama misalnya <code>middleware-app-canary.yaml</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>traefik.containo.us/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Middleware</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>middleware-app-canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>webapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>headers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>customRequestHeaders</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>X-Canary</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;enabled&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Kemudian modifikasi file <code>ingressroute-app.yaml</code> tadi menjadi seperti di bawah ini.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>traefik.containo.us/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>IngressRoute</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ingressroute-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>entryPoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>routes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Rule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>match</span><span class=p>:</span><span class=w> </span><span class=l>Host(`app.minikube1.local`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>service-app-current</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Rule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>match</span><span class=p>:</span><span class=w> </span><span class=l>Host(`app.minikube1.local`) &amp;&amp; HeadersRegexp(`X-Canary`, `enabled`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>service-app-canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Terapkan konfigurasi di atas pada Kubernetes.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl apply -f middleware-app-canary.yaml -f ingressroute-app.yaml
</span></span></code></pre></td></tr></table></div></div><p>Sekarang mari kita lakukan pengujian dengan melakukan 10 request tanpa header, dan 10 request lagi dengan menggunakan header.</p><p><figure><a class=lightgallery href=/canary-deployment-dan-mirroring-dengan-traefik/canary-by-header-result.png title="Dari hasil pengujian terlihat bahwa request hanya akan dialirkan ke versi kedua jika mengandung Header yang telah ditentukan" data-thumbnail=/canary-deployment-dan-mirroring-dengan-traefik/canary-by-header-result.png data-sub-html="<h2>Canary by Header result</h2><p>Dari hasil pengujian terlihat bahwa request hanya akan dialirkan ke versi kedua jika mengandung Header yang telah ditentukan</p>"><img class=lazyload src=/svg/loading.min.svg data-src=canary-by-header-result.png data-srcset="/canary-deployment-dan-mirroring-dengan-traefik/canary-by-header-result.png, canary-by-header-result.png 1.5x, /canary-deployment-dan-mirroring-dengan-traefik/canary-by-header-result.png 2x" data-sizes=auto alt=/canary-deployment-dan-mirroring-dengan-traefik/canary-by-header-result.png></a><figcaption class=image-caption>Canary by Header result</figcaption></figure></p><h3 id=mirroring>Mirroring</h3><p>Sekenario lainnya yang disediakan adalah melakukan mirroring atau shadowing.</p><p><figure><a class=lightgallery href=/canary-deployment-dan-mirroring-dengan-traefik/traffic-mirroring.png title="Skenario ini memungkinkan service tertentu untuk menerima trafik bayangan" data-thumbnail=/canary-deployment-dan-mirroring-dengan-traefik/traffic-mirroring.png data-sub-html="<h2>Traffic Mirroring</h2><p>Skenario ini memungkinkan service tertentu untuk menerima trafik bayangan</p>"><img class=lazyload src=/svg/loading.min.svg data-src=traffic-mirroring.png data-srcset="/canary-deployment-dan-mirroring-dengan-traefik/traffic-mirroring.png, traffic-mirroring.png 1.5x, /canary-deployment-dan-mirroring-dengan-traefik/traffic-mirroring.png 2x" data-sizes=auto alt=/canary-deployment-dan-mirroring-dengan-traefik/traffic-mirroring.png></a><figcaption class=image-caption>Traffic Mirroring</figcaption></figure></p><p>Selain dialirkan ke service - service canary tadi, Traefik juga dapat memanipulasi trafik yang lewat untuk menciptakan bayangannya, dan bayangan itu akan dialirkan ke service versi lain dengan persentase yang bisa ditentukan juga.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl create deployment deployment-app-mirror --image<span class=o>=</span>trianwar/hello-app:3.0 -n default
</span></span><span class=line><span class=cl>kubectl expose deployment deployment-app-mirror --name service-app-mirror --type ClusterIP --port <span class=m>8080</span> -n default
</span></span></code></pre></td></tr></table></div></div><p>Modifikasi file <code>ingressroute-app.yaml</code> yang telah dibuat sebelumnya.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>traefik.containo.us/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>IngressRoute</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ingressroute-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>entryPoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>routes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Rule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>match</span><span class=p>:</span><span class=w> </span><span class=l>Host(`app.minikube1.local`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mirroring-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>TraefikService</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Untuk menerapkan mirroring, kita juga perlu membuat objek bertipe <strong>TraefikService</strong> (bukan kubernetes service, kali ini adalah <a href=https://doc.traefik.io/traefik/v2.4/routing/providers/kubernetes-crd/#custom-resource-definition-crd target=_blank rel="noopener noreffer">Custom Resource Definition</a> milik Traefik).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>traefik.containo.us/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>TraefikService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>canary-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>weighted</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>service-app-current</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>service-app-canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>traefik.containo.us/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>TraefikService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mirroring-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mirroring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>canary-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>TraefikService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mirrors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>service-app-mirror</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>percent</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Simpan saja misalnya dengan nama <code>traefikservice-app.yaml</code> kemudian terapkan ke kubernetes.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl apply -f ingressroute-app.yaml -f traefikservice-app.yaml
</span></span></code></pre></td></tr></table></div></div><p>Lalu kita uji dengan melakukan 10 kali request.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=k>for</span> i in <span class=o>{</span>1..10<span class=o>}</span><span class=p>;</span> <span class=k>do</span> curl -s app.minikube1.local <span class=p>|</span> grep Version<span class=p>;</span> <span class=k>done</span><span class=p>;</span> kcmini logs <span class=k>$(</span>kcmini get pods -l <span class=nv>app</span><span class=o>=</span>deployment-app-mirror -o name<span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Akan terlihat bahwa rilis versi pertama menerima 8 request, sedangkan sisanya sebanyak 2 request ditangani oleh rilis versi kedua. Sementara itu, traffic sebanyak 10% atau dalam kasus ini setara 1 request dibuat bayangannya dan dialirkan ke rilis mirror.<figure><a class=lightgallery href=/canary-deployment-dan-mirroring-dengan-traefik/mirror-traffic-result.png title="Membuktikan teori Traffic Mirroring pada Traefik" data-thumbnail=/canary-deployment-dan-mirroring-dengan-traefik/mirror-traffic-result.png data-sub-html="<h2>Hasil Mirroring</h2><p>Membuktikan teori Traffic Mirroring pada Traefik</p>"><img class=lazyload src=/svg/loading.min.svg data-src=mirror-traffic-result.png data-srcset="/canary-deployment-dan-mirroring-dengan-traefik/mirror-traffic-result.png, mirror-traffic-result.png 1.5x, /canary-deployment-dan-mirroring-dengan-traefik/mirror-traffic-result.png 2x" data-sizes=auto alt=/canary-deployment-dan-mirroring-dengan-traefik/mirror-traffic-result.png></a><figcaption class=image-caption>Hasil Mirroring</figcaption></figure></p><hr><h2 id=advantages>Advantages</h2><p>Beberapa manfaat yang kita peroleh dari penerapan canary dan traffic mirroring adalah sebagai berikut:</p><ol><li>Minimalisir resiko/insiden dari rilisan baru di environment production.</li><li>Reduksi <em>cost</em> dan <em>effort</em> karena tidak perlu membangun cluster lain untuk environment pre-production.</li><li>Mengalirkan sebagian kecil <em>realtime traffic</em> ke rilisan baru untuk testing.</li><li>Mempercepat identifikasi terhadap Bug/Issue aplikasi.</li></ol><hr><h2 id=references>References</h2><ul><li><a href=https://blog.scienceandindustrymuseum.org.uk/canary-resuscitator/ target=_blank rel="noopener noreffer">blog.scienceandindustrymuseum.org.uk/canary-resuscitator</a></li><li><a href=https://traefik.io/glossary/kubernetes-deployment-strategies-blue-green-canary/ target=_blank rel="noopener noreffer">traefik.io/glossary/kubernetes-deployment-strategies-blue-green-canary</a></li><li><a href=https://doc.traefik.io/traefik/v2.4/routing/providers/kubernetes-crd/#custom-resource-definition-crd target=_blank rel="noopener noreffer">doc.traefik.io/traefik/v2.4/routing/providers/kubernetes-crd/#custom-resource-definition-crd</a></li><li><a href=https://doc.traefik.io/traefik/middlewares/http/headers/ target=_blank rel="noopener noreffer">doc.traefik.io/traefik/middlewares/http/headers</a></li><li><a href="https://docs.google.com/spreadsheets/d/191WWNpjJ2za6-nbG4ZoUMXMpUK8KlCIosvQB0f-oq3k/edit?fbclid=IwAR2vaSsGgTKZWw4RaA-meycB8tnfcWf1vp1pC29TEsUm-EYad1r5oAI-HDM#gid=907731238" target=_blank rel="noopener noreffer">&ldquo;Kubernetes Ingress Controllers&rdquo; List by learnk8s</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-06-26</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/canary-deployment-dan-mirroring-dengan-traefik/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/traefik/>Traefik</a>,&nbsp;<a href=/tags/ingress/>Ingress</a>,&nbsp;<a href=/tags/deployment/>Deployment</a>,&nbsp;<a href=/tags/kubernetes/>Kubernetes</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/setup-gitlab-server-with-ansible/ class=prev rel=prev title="Setup Gitlab Server with Ansible"><i class="fas fa-angle-left fa-fw"></i>Setup Gitlab Server with Ansible</a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=http://github.com/anwareset target=_blank>anwareset</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><script type=text/javascript src=https://anwars-blog.disqus.com/embed.js defer></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/typeit/typeit.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{},data:{"id-1":"init\u0026nbsp","id-2":"init\u0026nbsp"},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"},typeit:{cursorChar:"\u0026nbsp _",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:-1,speed:75}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>